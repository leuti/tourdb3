// ---------------------------------------------------------------------------------------------
// This is the main javascript file controling the behaviour of the tourdb page 
// 
// Created: 30.12.2017 - Daniel Leutwyler
// ---------------------------------------------------------------------------------------------
//
// Actions:
// * remove unnecessary where statement for filters (e.g. between dates, altitues)

// =================================================
// ====== G L O B A L   V A R   S E C T I O N ======
// =================================================

var today = new Date();                                              // Create unique file name for KML
//trackFileName = "track_" + today.getTime() + ".kml";               // file location & name for KML outputs ..
//segmentFileName = "seg_" + today.getTime() + ".kml";               // .. generated by disp_kml.php and displayed on client
//segmentFileNameURL = document.URL + "tmp/kml_disp/" + segmentFileName;   // file location & name for KML outputs

sqlWherePrev = "";                                             // variable to store previous sql where statement
sqlWhereSegmentsPrev = "";                                           // the gen_kml.php is only called if statement has changed

var trackKMLlayer;                                                   // map layer object containing all tracks
var segKMLlayer;                                                     // map layer object containing all segments
var mapSTlayer_grau;                                                 // map layer object containing the b/w swiss map

itemsArray = new Array();                                            // array to store selected peaks, waypoints, locations and participants

// ======================================================
// ====== Perform these actions when page is ready ======
// ======================================================
$(document).ready(function() {

    // Initialse all jquery functional fields for the mask display objects
    // ===================================================================

    // Initialise filter area as JQUERY Accordion                                                       
    $( "#dispObjAccordion" ).accordion({
        heightStyle: "content",                                      // hight of section dependent on content of section
        autoHeight: false,
        collapsible: true
    });

    $( "#dispFilTrk_dateFrom" ).datepicker({                         // Initalise field to select start date as JQUERY datepicker
        dateFormat: 'yy-mm-dd', 
        changeMonth: true,
        changeYear: true,
        showOn: "button",
        buttonImage: "css/images/calendar.gif",
        buttonImageOnly: true,
        buttonText: "Select date"
    });
    
    $( "#dispFilTrk_dateTo" ).datepicker({                           // Initalise field to select to date as JQUERY datepicker
        dateFormat: 'yy-mm-dd',
        changeMonth: true,
        changeYear: true,
        showOn: "button",
        buttonImage: "css/images/calendar.gif",
        buttonImageOnly: true,
        buttonText: "Select date"
    });

    $( "#dispFilTrk_type" ).selectable({});                          // Initialse field 'type' as JQUERY selectable

    $( "#dispFilTrk_subtype" ).selectable({});                       // Initialse field 'subtype' as JQUERY selectable

    // mapUF_sourceName
    $( "#dispFilSeg_sourceName" ).autocomplete({
        source: "services/get_auto_complete_values.php?field=segSourceFID",
        minLength: 2,
        select: function( event, ui ) {
            $( "#dispFilSeg_sourceFID" ).val( ui.item.id );
        },
        change: function( event, ui ) {
            if ( $( "#dispFilSeg_sourceName" ).val() == '' ) {
                    $( "#dispFilSeg_sourceFID" ).val( '' );
            }
        }
    });
    var mapUF_sourceFID = $( "#dispFilSeg_sourceFID" );

    // mapUF_segTypeFID
    $( "#dispFilSeg_segTypeFID" ).selectable({});
    
    // startLocName
    $( "#dispFilSeg_startLocName" ).autocomplete({
        source: "services/get_auto_complete_values.php?field=getWaypLong",
        minLength: 1,
        select: function( event, ui ) {
            $( "#dispFilSeg_startLocID" ).val( ui.item.id );
        },
        change: function( event, ui ) {
            if ( $( "#dispFilSeg_startLocName" ).val() == '' ) {
                    $( "#dispFilSeg_startLocID" ).val( '' );
            }
        }
    });
    var mapUF_startLocID = $( "#dispFilSeg_startLocID" ); 
    
    // startLocAlt 
    $( "#dispFilSeg_startLocAlt_slider" ).slider({
        range: true,
        min: 0,
        max: 5000,
        values: [ 400, 5000 ],
        slide: function( event, ui ) {
            $( "#dispFilSeg_startLocAlt_slider_values" ).val( "min. " + ui.values[ 0 ] + "m - max. " + ui.values[ 1 ] + "m" );
        }
    });
    $( "#dispFilSeg_startLocAlt_slider_values" ).val( "min. " + $( "#dispFilSeg_startLocAlt_slider" ).slider( "values", 0 ) +
    "m - max. " + $( "#dispFilSeg_startLocAlt_slider" ).slider( "values", 1 ) +"m" );
    
    // startLocType
    $( "#dispFilSeg_startLocType" ).selectable({});

    // targetLocName
    $( "#dispFilSeg_targetLocName" ).autocomplete({
        source: "services/get_auto_complete_values.php?field=getWaypLong",
        minLength: 1,
        select: function( event, ui ) {
            $( "#dispFilSeg_targetLocID" ).val( ui.item.id );
        },
        change: function( event, ui ) {
            if ( $( "#dispFilSeg_targetLocName" ).val() == '' ) {
                    $( "#dispFilSeg_targetLocID" ).val( '' );
            }
        }
    });
    var mapUF_targetLocID = $( "#dispFilSeg_targetLocID" ); 

    // targetLocAlt
    $( "#dispFilSeg_targetLocAlt_slider" ).slider({
        range: true,
        min: 0,
        max: 5000,
        values: [ 400, 5000 ],
        slide: function( event, ui ) {
            $( "#dispFilSeg_targetLocAlt_slider_values" ).val( "min. " + ui.values[ 0 ] + "m - max. " + ui.values[ 1 ] + "m" );
        }
    });
    $( "#dispFilSeg_targetLocAlt_slider_values" ).val( "min. " + $( "#dispFilSeg_targetLocAlt_slider" ).slider( "values", 0 ) +
    "m - max. " + $( "#dispFilSeg_targetLocAlt_slider" ).slider( "values", 1 ) +"m" );

    // targetLocType
    $( "#dispFilSeg_targetLocType" ).selectable({});

    // Region
    $( "#dispFilSeg_segRegion" ).autocomplete({
        source: "services/get_auto_complete_values.php?field=regionID",
        minLength: 1,
        select: function( event, ui ) {
            $( "#dispFilSeg_segRegionID" ).val( ui.item.id );
        },
        change: function( event, ui ) {
            if ( $( "#dispFilSeg_segRegion" ).val() == '' ) {
                    $( "#dispFilSeg_segRegionID" ).val( '' );
            }
        }
    });
    var mapUF_segRegionID = $( "#dispFilSeg_segRegionID" ); 

    // Area
    $( "#dispFilSeg_segArea" ).autocomplete({
        source: "services/get_auto_complete_values.php?field=areaID",
        minLength: 1,
        select: function( event, ui ) {
            $( "#dispFilSeg_segAreaID" ).val( ui.item.id );
        },
        change: function( event, ui ) {
            if ( $( "#dispFilSeg_segArea" ).val() == '' ) {
                    $( "#dispFilSeg_segAreaID" ).val( '' );
            }
        }
    });
    var mapUF_segAreaID = $( "#dispFilSeg_segAreaID" ); 

    $( "#dispFilSeg_grade" ).selectable({});
    $( "#dispFilSeg_climbGrade" ).selectable({});
    $( "#dispFilSeg_ehaft" ).selectable({});   

    // =====================================
    // ====== UI Tracks Admin Mask
    $( "#uiAdmTrk" ).tabs();                                         // Tabs in UI Track mask

    valComments = $( "#validateComments" );

    $( "#uiAdmTrk_fld_trkDateBegin" ).datepicker({                   // Initalise field to select start date as JQUERY datepicker
        dateFormat: 'yy-mm-dd', 
        changeMonth: true,
        changeYear: true,
        showOn: "button",
        buttonImage: "css/images/calendar.gif",
        buttonImageOnly: true,
        buttonText: "Select date"
    });

    $( "#uiAdmTrk_fld_trkDateFinish" ).datepicker({                  // Initalise field to select start date as JQUERY datepicker
        dateFormat: 'yy-mm-dd', 
        changeMonth: true,
        changeYear: true,
        showOn: "button",
        buttonImage: "css/images/calendar.gif",
        buttonImageOnly: true,
        buttonText: "Select date"
    });

    $( "#uiAdmTrk_fld_trkSaison" ).selectmenu();
    $( "#uiAdmTrk_fld_trkType" ).selectmenu();
    $( "#uiAdmTrk_fld_trkSubType" ).selectmenu();

    $( "#uiAdmTrk_peakSrch" ).autocomplete({
        source: "services/autoComplete.php?field=peak",
        minLength: 2,
        select: function( event, ui ) {                              // function fires on select of element   
            $( "" ).val( ui.item.id );                               // Set search field = found content
            id = ui.item.id;                                         // id = id of found item
            value = ui.item.value;                                   // value = name of found item

            // Initialise peakList array
            var itemsList =  new Object();                                  

            // Add new peak to array
            itemsList.itemId = id;                                   // id of item selected
            itemsList.itemName = value;                              // Name of item selected
            itemsList.itemType = "peak";                             // Type of item (must be 4 char)
            itemsList.disp_f = true;                                 // Set display to true (if false --> item is not shown)
            itemsList.reached_f = true;                              // Set reached flag to true as default

            itemsArray.push(itemsList);                              // Push record to array

            drawItemsTables ( itemsArray, "peak" );                  // draw table with selected item and delete buttoon
        }
    });

    $( "#uiAdmTrk_waypSrch" ).autocomplete({
        source: "services/autoComplete.php?field=wayp",
        minLength: 2,
        select: function( event, ui ) {                              // see above
            $( "" ).val( ui.item.id );
            id = ui.item.id;
            value = ui.item.value;

            // Initialise peakList array
            var itemsList =  new Object();

            // Add new wayp to array
            itemsList.itemId = id;                                   // id of item selected
            itemsList.itemName = value;                              // Name of item selected
            itemsList.itemType = "wayp";                             // Type of item (must be 4 char)
            itemsList.disp_f = true;                                 // Set display to true (if false --> item is not shown)
            itemsList.reached_f = true;                              // Set reached flag to true as default

            itemsArray.push(itemsList);

            drawItemsTables ( itemsArray, "wayp" ); 
        }
    });

    $( "#uiAdmTrk_locaSrch" ).autocomplete({
        source: "services/autoComplete.php?field=loca",
        minLength: 2,
        select: function( event, ui ) {                              // see above
            $( "" ).val( ui.item.id );
            id = ui.item.id;
            value = ui.item.value;
        
            // Initialise peakList array
            var itemsList =  new Object();

            // Add new loc to array
            itemsList.itemId = id;                                   // id of item selected
            itemsList.itemName = value;                              // Name of item selected
            itemsList.itemType = "loca";                             // Type of item (must be 4 char)
            itemsList.disp_f = true;                                 // Set display to true (if false --> item is not shown)
            itemsList.reached_f = true;                              // Set reached flag to true as default --> not stored

            itemsArray.push(itemsList);

            drawItemsTables ( itemsArray, "loca" ); 
        }
    });

    $( "#uiAdmTrk_partSrch" ).autocomplete({
        source: "services/autoComplete.php?field=part",
        minLength: 2,
        select: function( event, ui ) {                              // see above
            $( "" ).val( ui.item.id );
            id = ui.item.id;
            value = ui.item.value;
        
            // Initialise peakList array
            var itemsList =  new Object();

            // Add new part to array
            itemsList.itemId = id;                                   // id of item selected
            itemsList.itemName = value;                              // Name of item selected
            itemsList.itemType = "part";                             // Type of item (must be 4 char)
            itemsList.disp_f = true;                                 // Set display to true (if false --> item is not shown)
            itemsList.reached_f = true;                              // Set reached flag to true as default --> not stored

            itemsArray.push(itemsList);                              // Add selected item to array

            drawItemsTables ( itemsArray, "part" ); 
        }
    });

    // Evaluate which button/panel is active
    $('.navBtns_btns').each(function() {
        var $thisTopicButton = $(this);                              // $thisTopicButton becomes ul.navBtns_btns
        $activeButton = $thisTopicButton.find('li.active');          // Find and store current active li element
        var $activeButtonA = $activeButton.find('a');                // Get link <a> from active li element 
        $topicButton = $($activeButtonA.attr('href'));               // Get active panel      
    });

    // Evaluate which button/panel is active
    $('.uiAdmTrk_btns').each(function() {
        var $clickedUpdTrkBtn = $(this);                             // $clickedUpdTrkBtn becomes ul.uiAdmTrk_btns
        $actUpdTrkBtn = $clickedUpdTrkBtn.find('li.active');         // Find and store current active li element
        var $clickedUpdTrkButton_liA = $actUpdTrkBtn.find('a');      // Get link <a> from active li element 
        $actUpdTrkTab = $($clickedUpdTrkButton_liA.attr('href'));    // Get active panel      
    });

    // Change to selected panel
    $(this).on('click', '.navBtns_btns_a', function(e) {                  
        e.preventDefault();                                          // Prevent link behaviour
        var $activeButtonA = $(this)                                 // Store the current link <a> element
        var buttonId = this.hash;                                    // Get div class of selected topic (e.g #panelDisplay)
        
        // Run following block if selected topic is currently not active
        if (buttonId && !$activeButtonA.is('.active')) {
            $topicButton.removeClass('active');                      // Make current panel inactive
            $activeButton.removeClass('active');                     // Make current tab inactive

            $topicButton = $(buttonId).addClass('active');           // Make new panel active
            $activeButton = $activeButtonA.parent().addClass('active'); // Make new tab active
        }
    }); 
      
    // ==========================================================================
    // ========================== panelLogin ====================================
    // ==========================================================================

    // ............................................................................
    // Executes code below when user clicks the 'Login' button
    $(document).on('click', '#navBtns_btn_login', function (e) {
        e.preventDefault();                                                                             
        var xhr = new XMLHttpRequest();                              // create new xhr object
        
        // Execute following code JSON object is received from importGpsTmp.php service
        xhr.onload = function() {
            if (xhr.status === 200) {                                // when all OK
                respObj = JSON.parse(xhr.responseText);       // transfer JSON into response object array

                sessionid = respObj.sessionid; 
                loginstatus = respObj.loginstatus;
                if ( loginstatus == "ERROR")
                { 
                    $('#statusMessage').text('Login failed');
                    $('#statusMessage').show().delay(5000).fadeOut();
                } else {
                    // Open Panel Display
                    var $activeButtonA = $('#navBtns_btn_diplay_a'); // Store the current link <a> element
                    buttonId = $activeButtonA.attr('href'); 
                    
                    // Run following block if selected topic is currently not active
                    $topicButton.removeClass('active');              // Make current panel inactive
                    $activeButton.removeClass('active');             // Make current tab inactive
                    $topicButton = $(buttonId).addClass('active');   // Make new panel active
                    $activeButton = $activeButtonA.parent().addClass('active'); // Make new tab active
                    $('.loginReq').removeClass('loginReq');          // Free deactivated menues
                    $('#navBtns_btn_login').addClass('loginReq');

                    $('#statusMessage').text('Login successful');
                    $("#statusMessage").show().delay(5000).fadeOut(); 
                    tourdbMap = drawMapEmpty('displayMap-ResMap');         // Draw empty map (without additional layers) 
                    //drawMapEmpty('displayMap-ResMap');         // Draw empty map (without additional layers) 
                }
            }
        }

        var jsonObject = {};                                         // Initialise JSON Object for server 
        $loginName = ($('#loginName').val());                        // read login name from mask
        phpLocation = "services/login.php";                          // Variable to store location of php file
        jsonObject["loginName"] = $loginName;                        // append login name to JSON object
        jsonObject["loginPasswd"] = ($('#loginPasswd').val());       // append password to JSON object
        xhr.open ('POST', phpLocation, true);                        // open XMLHttpRequest 
        xhr.setRequestHeader( "Content-Type", "application/json" );  // Set header to JSON
        jsn = JSON.stringify(jsonObject);                            // Convert jsonn object to JSON formated string
        xhr.send( jsn );                                             // send JSON object to service using xhr   
    });
});

// ==========================================================================
// ========================== panelDisplay ==================================
// ==========================================================================

// On click the minimize large display objects icon to minimized
$(document).on('click', '#dispObjMenuLargeClose', function(e) {
    e.preventDefault();
    var $activeButton = $(this);
    $activeButton.parent().removeClass('visible');
    $activeButton.parent().addClass('hidden');
    $('.dispObjMini').removeClass('hidden');
    $('.dispObjMini').addClass('visible');
})

// On click of minimized filter icon --> open large display objects mask
$(document).on('click', '#dispObjMenuMiniOpen', function(e) {
    e.preventDefault();
    var $activeButton = $(this);
    $activeButton.parent().removeClass('visible');
    $activeButton.parent().addClass('hidden');
    $('.dispObjOpen').removeClass('hidden');
    $('.dispObjOpen').addClass('visible');
})

// Executes code below when user clicks the 'Apply' filter button for tracks
$(document).on('click', '.applyFilterButton', function (e) {
    e.preventDefault();
    $clickedButton = this.id;                                       // store id of button clicked

    // Initialise overall variables
    //var dispObj = {};                                     // Array containing information of each object type to be displayed
    //var sqlWhereCurrent = "";                                              // Initialise var for the current where string
    var sqlWherePrev_tracks = "";
    var sqlWherePrev_segments = "";
    var sqlWherePrev_peaks_100 = "";
    var sqlWherePrev_peaks_1000 = "";
    var sqlWherePrev_peaks_2000 = "";
    var sqlWherePrev_peaks_3000 = "";
    var sqlWherePrev_peaks_4000 = "";
    var sqlWherePrev_cant = "";
    var sqlWherePrev_huts = "";
    
    
    // ********************************************************************************************
    // Build SQL WHERE statement for tracks

    // Initialise tracks variables
    var whereStatement = [];                                        // Initialise array for whereStatement
    var whereString = "";                                           // Initialise var for where string
   
    // Field trackID from / to
    var trackIdFrom = "";                                           // Initialse var for track id from 
    var trackIdTo = "";                                             // Initialse var for track id to
    if ( ($('#dispFilTrk_trackIdFrom').val()) != "" ) {                           
        trackIdFrom = $('#dispFilTrk_trackIdFrom').val();
    } else {
        trackIdFrom = "";
    };

    if ( ($('#dispFilTrk_trackIdTo').val()) != "" ) {                           
        trackIdTo = $('#dispFilTrk_trackIdTo').val();
    } else {
        trackIdTo = "";
    };

    if ( trackIdFrom != "" && trackIdTo != "" ) {
        whereString = "trkID >= " + trackIdFrom + " AND trkId <= " + trackIdTo;   // complete WHERE BETWEEN statement
    } else if ( trackIdFrom != "" ) {
        whereString = "trkID >= " + trackIdFrom;                                  // complete WHERE BETWEEN statement
    } else if ( trackIdTo != "" ) {
        whereString = "trkId <= " + trackIdTo;                                    // complete WHERE BETWEEN statement
    }

    if ( whereString.length > 0 ) {
        whereStatement.push( whereString );                                       // Add to where Statement array
    }

    // Field track name
    var whereString = "";
    if ( ($('#dispFilTrk_trackName').val()) != "" ) {                           
        whereString = "trkTrackName like '%" + $('#dispFilTrk_trackName').val() + "%'";
        whereStatement.push( whereString );
    };

    // Field route
    var whereString = "";
    if ( ($('#dispFilTrk_route').val()) != "" ) {
        whereString = "trkRoute like '%" + $('#dispFilTrk_route').val() + "%'";
        whereStatement.push( whereString );
    };

    // Field date begin (date finished not used)
    var whereString = "";                                                       // clear where string
    fromDateArt = "1968-01-01";                                                 // Set from date in case no date is entered
    var today = new Date();                                                     // Set to date to today in case no date is entered
    month = today.getMonth()+1;                                                 // Extract month (January = 0)
    toDateArt = today.getFullYear() + '-' + month + '-' + today.getDate();      // Set to date to today (format yyyy-mm-dd)
    
    if ( ($('#dispFilTrk_dateFrom').val()) != "" ) {                            // Overwrite fromDate with value entered by user
        fromDate = ($('#dispFilTrk_dateFrom').val());
    } else {
        fromDate = "";
    }

    if ( ($('#dispFilTrk_dateTo').val()) != "" ) {                              // Overwrite toDate with value entered by user
        toDate = ($('#dispFilTrk_dateTo').val())                                // Add to where Statement array
    } else {
        toDate = "";
    }

    if ( fromDate != "" && toDate != "" ) {
        whereString = "trkDateBegin BETWEEN '" + fromDate + "' AND '" + toDate + "'";           // complete WHERE BETWEEN statement
    } else if ( fromDate != "" ) {
        whereString = "trkDateBegin BETWEEN '" + fromDate + "' AND '" + toDateArt + "'";        // complete WHERE BETWEEN statement
    } else if ( toDate != "" ) {
        whereString = "trkDateBegin BETWEEN '" + fromDateArt + "' AND '" + toDate + "'";        // complete WHERE BETWEEN statement
    }
    if ( whereString.length > 0 ) {
        whereStatement.push( whereString );                                         // Add to where Statement array
    }

    // Field type
    var whereString = "";
    $('#dispFilTrk_type .ui-selected').each(function() {                        // loop through each selected type item
        var itemId = this.id                                                    // Extract id of selected item
        whereString = whereString + "'" + itemId.slice(16) + "',";              // Substring tyye from id
    });
    if ( whereString.length > 0 ) {
        whereString = whereString.slice(0,whereString.length-1);                // remove last comma
        whereString = "trkType in (" + whereString + ")";                       // complete SELECT IN statement
        whereStatement.push( whereString );                                     // Add to where Statement array
    };

    // Field subtype
    var whereString = "";                                                       
    $('#dispFilTrk_subtype .ui-selected').each(function() {                     // loop through each selected type item
        var itemId = this.id                                                    // Extract id of selected item
        whereString = whereString + "'" + itemId.slice(19) + "',";              // Substring tyye from id
    });
    if ( whereString.length > 0 ) {
        whereString = whereString.slice(0,whereString.length-1);                // remove last comma
        whereString = "trkSubType in (" + whereString + ")";                    // complete SELECT IN statement
        whereStatement.push( whereString );                                     // Add to where Statement array
    }           

    // Field participants
    var whereString = "";
    if ( ($('#dispFilTrk_participants').val()) != "" ) {
        whereString = "trkParticipants like '%" + $('#dispFilTrk_participants').val() + "%'";
        whereStatement.push( whereString );
    };

    // Field country
    var whereString = "";
    if ( ($('#dispFilTrk_country').val()) != "" ) {
        whereString = "trkCountry like '%" + $('#dispFilTrk_country').val() + "%'";
        whereStatement.push( whereString );
    };
    
    // ========== Put all where statements together
    if ( whereStatement.length > 0 ) {
        var sqlWhereCurrent = "WHERE ";

        for (var i=0; i < whereStatement.length; i++) {
            sqlWhereCurrent += whereStatement[i];
            sqlWhereCurrent += " AND ";
        }
        sqlWhereCurrent = sqlWhereCurrent + " trkLoginName ='" + $loginName + "'";
    } 

    // Create new display object for current object
    var objName = "tracks";
    var phpUrl = "services/gen_kml.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_tracks ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }
    
    var dispObject_tracks = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ********************************************************************************************
    // ****** Build SQL WHERE statement for segments *******
    
    // Initialize segments variables
    
    //var sqlWhereSegments = "";                                      // Initialise var for where string for segments
    var whereStatement = [];                                        // Initialise array for whereStatement
    var whereString = "";                                           // Initialise var for where string
    var sqlWhereCurrent = "";                                        // Initialise var for where string for tracks
    var selected = [];
    var sqlName;
    
    // Field segment type
    $('#dispFilSeg_segTypeFID .ui-selected').each(function() {
        var itemId = this.id;
        sqlName = "segTypeFID";
        var criteria = itemId.slice(sqlName.length+1,itemId.length);            // +1 to remove _
        selected.push( criteria );
    });
    if ( selected.length > 0 ) {
        whereString = sqlName + " in (";
        var i;
        for (i=0; i<selected.length; ++i) {
            whereString += "'" + selected[i] + "',";
        }
    whereString = whereString.slice(0,whereString.length-1) + ")"; 
    whereStatement.push( whereString );                                         // Add to where Statement array
    }

    // Field segment name
    var whereString = "";
    if ( ($('#dispFilSeg_segName').val()) != "" ) {
        whereString = "segName like '%" + ($('#dispFilSeg_segName').val()) + "%'";      
        whereStatement.push( whereString );
    };

    // Field Start Location (ID selected)
    var whereString = "";
    if ( ($('#dispFilSeg_startLocID').val()) != "" ) {
        whereString = "startLocType = " + ($('#dispFilSeg_startLocID').val()); 
        whereStatement.push( whereString );
    };

    // Field Altitude of start location 
    /*
    var whereString = "";
    whereString = " startLocAlt >= " + $( "#dispFilSeg_startLocAlt_slider" ).slider( "values", 0 );
    whereString += " AND startLocAlt <= " + $( "#dispFilSeg_startLocAlt_slider" ).slider( "values", 1 );
    whereStatement.push( whereString );     
    */

    // Field type of start location
    var selected = [];
    var sqlName;
    var whereString = "";    
    $('#dispFilSeg_startLocType .ui-selected').each(function() {
        var itemId = this.id;
        sqlName = itemId.slice(0,itemId.length-2);
        var criteria = itemId.slice(sqlName.length+1,itemId.length);            // +1 to remove _
        selected.push( criteria );
    });
    if ( selected.length > 0 ) {
        whereString = sqlName + " in (";
        var i;
        for (i=0; i<selected.length; ++i) {
            whereString += "'" + selected[i] + "',";
        }
    whereString = whereString.slice(0,whereString.length-1) + ")"; 
    whereStatement.push( whereString );                                         // Add to where Statement array
    }
    
    // Field target location (ID selected)
    var whereString = "";
    if ( ($('#dispFilSeg_targetLocID').val()) != "" ) {
        whereString = "targetLocType = " + ($('#dispFilSeg_startLocID').val()); 
        whereStatement.push( whereString );
    };

    // Field target location altitude
    /*
    var whereString = "";
    whereString = " targetLocAlt >= " + $( "#dispFilSeg_targetLocAlt_slider" ).slider( "values", 0 );
    whereString += " AND startLocAlt <= " + $( "#dispFilSeg_targetLocAlt_slider" ).slider( "values", 1 );
    whereStatement.push( whereString );            
    */

    // Field target location type
    var selected = [];
    var sqlName;
    var whereString = "";
    $('#dispFilSeg_targetLocType .ui-selected').each(function() {
        var itemId = this.id;
        sqlName = "targetLocType";
        var criteria = itemId.slice(sqlName.length+1,itemId.length);            // +1 to remove _
        selected.push( criteria );
    });
    if ( selected.length > 0 ) {
        whereString = sqlName + " in (";
        var i;
        for (i=0; i<selected.length; ++i) {
            whereString += "'" + selected[i] + "',";
        }
    whereString = whereString.slice(0,whereString.length-1) + ")"; 
    whereStatement.push( whereString );                                         // Add to where Statement array
    }

    // Field region
    var whereString = "";
    if ( ($('#dispFilSeg_segRegionID').val()) != "" ) {
        whereString = "regionId = " + ($('#dispFilSeg_segRegionID').val()); 
        whereStatement.push( whereString );
    };

    // Field area
    var whereString = "";
    if ( ($('#dispFilSeg_segAreaID').val()) != "" ) {
        whereString = "areaId = " + ($('#dispFilSeg_segAreaID').val()); 
        whereStatement.push( whereString );
    };
    
    // Field grade
    var selected = [];
    var sqlName;
    var whereString = "";    
    $('#dispFilSeg_grade .ui-selected').each(function() {
        var itemId = this.id;
        sqlName = "grade";
        var criteria = itemId.slice(sqlName.length+1,itemId.length);            // +1 to remove _
        selected.push( criteria );
    });
    if ( selected.length > 0 ) {
        whereString = sqlName + " in (";
        var i;
        for (i=0; i<selected.length; ++i) {
            whereString += "'" + selected[i] + "',";
        }
        whereString = whereString.slice(0,whereString.length-1) + ")"; 
        whereStatement.push( whereString );                                         // Add to where Statement array
    }
    
    // Field climbGrade
    var selected = [];
    var sqlName;
    var whereString = "";    
    $('#dispFilSeg_climbGrade .ui-selected').each(function() {
        var itemId = this.id;
        sqlName = "climbGrade";
        var criteria = itemId.slice(sqlName.length+1,itemId.length);            // +1 to remove _
        selected.push( criteria );
    });
    if ( selected.length > 0 ) {
        whereString = sqlName + " in (";
        var i;
        for (i=0; i<selected.length; ++i) {
            whereString += "'" + selected[i] + "',";
        }
        whereString = whereString.slice(0,whereString.length-1) + ")"; 
        whereStatement.push( whereString );                                         // Add to where Statement array
    }

    // Field Ernsthaftigkeit
    var whereString = "";
    $('#dispFilSeg_ehaft .ui-selected').each(function() {
        var itemId = this.id;
        var sqlName = "ehaft";
        var lenCriteria = itemId.length;
        var startCriteria = sqlName.length + 1;
        whereString = whereString + itemId.slice(startCriteria,lenCriteria) + "',";  
        if ( whereString.length > 0 ) {
            whereString = whereString.slice(0,whereString.length-1);            // remove last comma
            whereString = sqlName + " in (" + whereString + ")";                // complete SELECT IN statement
            whereStatement.push( whereString );                                 // Add to where Statement array
        };
    });
   
    // *******************************************
    // ========= Put all where statements together
    //
    if ( whereStatement.length > 0 ) {
        var sqlWhereCurrent = "WHERE ";

        for (var i=0; i < whereStatement.length; i++) {
            sqlWhereCurrent += whereStatement[i];
            sqlWhereCurrent += " AND ";
        }
        sqlWhereCurrent = sqlWhereCurrent.slice(0,sqlWhereCurrent.length-5);
        sqlWhereCurrent = sqlWhereCurrent; 
    }

    // Create new display object for current object
    var objName = "segments";
    var phpUrl = "services/gen_kml.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_segments ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }
    
    var dispObject_segments = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ********************************************************************************************
    // ****** Display waypoints
    
    // ---------------------------------------------------------------------------------------
    // Peaks < 1000
    var sqlWhereCurrent = "WHERE "
    sqlWhereCurrent += "waypTypeFID = 5 AND ";
    sqlWhereCurrent += "waypAltitude < 1000 AND ";
    sqlWhereCurrent += "trkLoginName = '" + $loginName + "' ";

    // Create new display object for current object
    var objName = "peaks_100";
    var phpUrl = "services/gen_wayp.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_peaks_100 ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }

    var dispObject_peaks_100 = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ---------------------------------------------------------------------------------------
    // Peaks 1000er
    var sqlWhereCurrent = "WHERE ";                                        // Initialise array for whereStatement
    sqlWhereCurrent += "waypTypeFID = 5 AND ";
    sqlWhereCurrent += "waypAltitude < 2000 AND ";
    sqlWhereCurrent += "waypAltitude >= 1000 AND "
    sqlWhereCurrent += "trkLoginName = '" + $loginName + "' ";
    
    var objName = "peaks_1000";
    var phpUrl = "services/gen_wayp.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_peaks_1000 ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }
    
    var dispObject_peaks_1000 = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ---------------------------------------------------------------------------------------
    // Peaks 2000er
    var sqlWhereCurrent = "WHERE ";                                        // Initialise array for whereStatement
    sqlWhereCurrent += "waypTypeFID = 5 AND ";
    sqlWhereCurrent += "waypAltitude < 3000 AND ";
    sqlWhereCurrent += "waypAltitude >= 2000 AND ";
    sqlWhereCurrent += "trkLoginName = '" + $loginName + "' ";
    
    var objName = "peaks_2000";
    var phpUrl = "services/gen_wayp.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_peaks_2000 ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }
    
    var dispObject_peaks_2000 = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ---------------------------------------------------------------------------------------
    // Peaks 3000er
    var sqlWhereCurrent = "WHERE ";                                        // Initialise array for whereStatement
    sqlWhereCurrent += "waypTypeFID = 5 AND ";
    sqlWhereCurrent += "waypAltitude < 4000 AND ";
    sqlWhereCurrent += "waypAltitude >= 3000 AND ";
    sqlWhereCurrent += "trkLoginName = '" + $loginName + "' ";
    
    var objName = "peaks_3000";
    var phpUrl = "services/gen_wayp.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_peaks_3000 ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }
    
    var dispObject_peaks_3000 = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ---------------------------------------------------------------------------------------
    // Peaks 4000er
    var sqlWhereCurrent = "WHERE ";                                        // Initialise array for whereStatement
    sqlWhereCurrent += "waypTypeFID = 5 AND ";
    sqlWhereCurrent += "waypAltitude > 4000 AND ";
    sqlWhereCurrent += "trkLoginName = '" + $loginName + "' ";

    var objName = "peaks_4000";
    var phpUrl = "services/gen_wayp.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_peaks_4000 ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }
    
    var dispObject_peaks_4000 = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ---------------------------------------------------------------------------------------
    // Peaks Top of Cantons
    var sqlWhereCurrent = "WHERE ";                                        // Initialise array for whereStatement
    sqlWhereCurrent += "waypTypeFID = 5 AND ";
    sqlWhereCurrent += "waypAltitude < 1000 AND ";
    sqlWhereCurrent += "trkLoginName = '" + $loginName + "' ";

    var objName = "cant";
    var phpUrl = "services/gen_wayp.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_cant ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }
    
    var dispObject_cant = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ---------------------------------------------------------------------------------------
    // Huts
    var sqlWhereCurrent = "WHERE ";                                        // Initialise array for whereStatement
    sqlWhereCurrent += "waypTypeFID = 4 AND ";
    sqlWhereCurrent += "trkLoginName = '" + $loginName + "' ";

    var objName = "huts";
    var phpUrl = "services/gen_wayp.php";
    var jsonObject = {
        sessionid: sessionid,
        objectName: objName,
        sqlWhere: sqlWhereCurrent
    }
    jsn = JSON.stringify ( jsonObject )
    if ( sqlWhereCurrent == sqlWherePrev_huts ) {
        var genKml = false;
        var ajaxCall = {
            url: "services/no_kml.php",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: ""
        };
    } else {
        var genKml = true;
        var ajaxCall = {
            url: phpUrl,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            data: jsn
        }
    }
    
    var dispObject_huts = new DisplayObj( objName, sqlWherePrev, sqlWhereCurrent, genKml, jsn, ajaxCall )

    // ********************************************************************************************
    // Draw map fresh

    // delete current map
    var element = document.getElementById('displayMap-ResMap');
    var parent = element.parentNode
    parent.removeChild(element);
    parent.innerHTML = '<div id="displayMap-ResMap"></div>';

    // ********************************************************************************************
    // ***** Loop through display array and assign relevant parameters to jsonObject

    // Prepare ajax call for TRACKS kml
    
    // Wait for each ajax call to complete & continue only when all are finished (regardless if in error)
    $.when( $.ajax(dispObject_tracks.ajaxCall),  
            $.ajax(dispObject_segments.ajaxCall),
            $.ajax(dispObject_peaks_100.ajaxCall),
            $.ajax(dispObject_peaks_1000.ajaxCall),
            $.ajax(dispObject_peaks_2000.ajaxCall),
            $.ajax(dispObject_peaks_3000.ajaxCall),
            $.ajax(dispObject_peaks_4000.ajaxCall),
            $.ajax(dispObject_cant.ajaxCall),
            $.ajax(dispObject_huts.ajaxCall)
    // resp_xy contain the response array of the ajax call [data, statusText, jqXHR]
    ).done( function ( resp_tracks, resp_segments, resp_peaks_100, resp_peaks_1000, 
                      resp_peaks_2000, resp_peaks_3000, resp_peaks_4000, resp_peaks_cant, resp_peaks_huts ) {
        respObj = {};
        sqlWherePrev_tracks = dispObject_tracks.sqlWhereCurrent;
        sqlWherePrev_segments = dispObject_segments.sqlWhereCurrent;
        sqlWherePrev_peaks_100 = dispObject_peaks_100.sqlWhereCurrent;
        sqlWherePrev_peaks_1000 = dispObject_peaks_1000.sqlWhereCurrent;
        sqlWherePrev_peaks_2000 = dispObject_peaks_2000.sqlWhereCurrent;
        sqlWherePrev_peaks_3000 = dispObject_peaks_3000.sqlWhereCurrent;
        sqlWherePrev_peaks_4000 = dispObject_peaks_4000.sqlWhereCurrent;
        sqlWherePrev_cant = dispObject_cant.sqlWhereCurrent;
        sqlWherePrev_huts = dispObject_huts.sqlWhereCurrent;

        console.log("track finished: " + resp_tracks[0]);
        console.log("segments finished: " + resp_segments[0]);
        console.log("segments finished: " + resp_peaks_100[0]);

        var coordTop_tracks = Number(resp_tracks[0].coordTop);
        var coordTop_segments = Number(resp_segments[0].coordTop);
        var coordTop = Math.max(coordTop_tracks, coordTop_segments);
        
        var coordBottom_tracks = Number(resp_tracks[0].coordBottom);
        var coordBottom_segments = Number(resp_segments[0].coordBottom);
        var coordBottom = Math.min(coordBottom_tracks, coordBottom_segments);

        var coordLeft_tracks = Number(resp_tracks[0].coordLeft);
        var coordLeft_segments = Number(resp_segments[0].coordLeft);
        var coordLeft = Math.min(coordLeft_tracks, coordLeft_segments);
        
        var coordRight_tracks = Number(resp_tracks[0].coordRight);
        var coordRight_segments = Number(resp_segments[0].coordRight);
        var coordRight = Math.max(coordRight_tracks, coordRight_segments);
        
        // Evluate coord center (if route is outside CH - show empty CH map)
        var coordCenterY = ( coordTop + coordBottom ) / 2;
        var coordCenterX = ( coordRight + coordLeft ) / 2;
        
        // Calculate required resolution
        resolution1 = ( coordTop - coordBottom ) / 200;
        resolution2 = ( coordRight - coordLeft ) / 200;
        if ( resolution1 > resolution2 ) {
            resolution = resolution1;
        } else {
            resolution = resolution2;
        }

        console.info("resolution: " + resolution + " - CoordCenterX: " + coordCenterX + " - CoordCenterY: " + coordCenterY);
        // Draw empty map & center to provided coordinate
        var tourdbMap = new ga.Map({
            target: 'displayMap-ResMap',
            view: new ol.View({resolution: resolution, center: [coordCenterX, coordCenterY]})
        });
        mapSTlayer_grau = ga.layer.create('ch.swisstopo.pixelkarte-grau');
        tourdbMap.addLayer(mapSTlayer_grau);                              // add map layer to map
        
        // Draw kml file for tracks 
        if ( dispObject_tracks.genKml ) {                                            // var is true when user has set filter on tracks
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/tracks.kml";
        
            // Create the KML Layer for tracks
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for tracks
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for tracks 
        if ( dispObject_tracks.genKml ) {                                            // var is true when user has set filter on tracks
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/tracks.kml";
        
            // Create the KML Layer for tracks
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for tracks
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for segments 
        if ( dispObject_segments.genKml ) {                                            // var is true when user has set filter on segments
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/segments.kml";
        
            // Create the KML Layer for segments
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for segments
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for peaks_100 
        if ( dispObject_peaks_100.genKml ) {                                            // var is true when user has set filter on peaks_100
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/peaks_100.kml";
        
            // Create the KML Layer for peaks_100
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for peaks_100
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for peaks_1000 
        if ( dispObject_peaks_1000.genKml ) {                                            // var is true when user has set filter on peaks_1000
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/peaks_1000.kml";
        
            // Create the KML Layer for peaks_1000
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for peaks_1000
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for peaks_2000 
        if ( dispObject_peaks_2000.genKml ) {                                            // var is true when user has set filter on peaks_2000
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/peaks_2000.kml";
        
            // Create the KML Layer for peaks_2000
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for peaks_2000
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for peaks_3000 
        if ( dispObject_peaks_3000.genKml ) {                                            // var is true when user has set filter on peaks_3000
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/peaks_3000.kml";
        
            // Create the KML Layer for peaks_3000
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for peaks_3000
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for peaks_4000 
        if ( dispObject_peaks_4000.genKml ) {                                            // var is true when user has set filter on peaks_4000
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/peaks_4000.kml";
        
            // Create the KML Layer for peaks_4000
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for peaks_4000
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for cant 
        if ( dispObject_cant.genKml ) {                                            // var is true when user has set filter on cant
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/cant.kml";
        
            // Create the KML Layer for cant
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for cant
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }

        // Draw kml file for huts 
        if ( dispObject_huts.genKml ) {                                            // var is true when user has set filter on huts
            $kmlFile = document.URL + "tmp/kml_disp/" + sessionid + "/huts.kml";
        
            // Create the KML Layer for huts
            kmlLayer = new ol.layer.Vector({                       // create new vector layer for huts
                source: new ol.source.Vector({                          // Set source to kml file
                    url: $kmlFile,
                    format: new ol.format.KML({
                        projection: 'EPSG:21781'
                    })
                })
            });
            tourdbMap.addLayer(kmlLayer);                                // add track layer to map
        }
        
        // Popup showing the position the user clicked
        var popup = new ol.Overlay({                                    // popup to display track details
            element: $('<div title="KML"></div>')[0]
        });
        tourdbMap.addOverlay(popup);

        // On click we display the feature informations (code basis from map admin sample library)
        tourdbMap.on('singleclick', function(evt) {
            var pixel = evt.pixel;
            var coordinate = evt.coordinate;
            var feature = tourdbMap.forEachFeatureAtPixel(pixel, function(feature, layer) {
                return feature;
            });
            var element = $(popup.getElement());
            element.popover('destroy');
            if (feature) {
            popup.setPosition(coordinate);
            element.popover({
                'placement': 'top',
                'animation': false,
                'html': true,
                'content': feature.get('name')
            });
            element.popover('show');
            }
        });

        // Change cursor style when cursor is hover over a feature
        tourdbMap.on('pointermove', function(evt) {
            var feature = tourdbMap.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                return feature;
            });
            tourdbMap.getTargetElement().style.cursor = feature ? 'pointer' : '';
        });

        // display message
        $('#statusMessage').text(respObj.message);
        $("#statusMessage").show().delay(5000).fadeOut();

    });
    
});

// ==========================================================================
// ========================== panelImport ===================================
// ==========================================================================

// Change to selected panel
$(document).on('click', '.uiAdmTrk_btns_a', function(e) {                  
    e.preventDefault();                                             // Prevent link behaviour
    
    var $activeButtonA = $(this)                                    // Store the current link <a> element
    var buttonId = this.hash;                                       // Get div class of selected topic (e.g #panelDisplay)
    
    // Run following block if selected topic is currently not active
    if (buttonId && !$activeButtonA.is('.active')) {
        $actUpdTrkTab.removeClass('active');                        // Make current panel inactive
        $actUpdTrkBtn.removeClass('active');                        // Make current tab inactive
        
        $actUpdTrkTab = $(buttonId).addClass('active');             // Make new panel active
        $actUpdTrkBtn = $activeButtonA.parent().addClass('active'); // Make new tab active
    }
}); 

// Upon click on the 'Upload GPX File' button --> call importGps.php in temp mode
$(document).on('click', '#buttonUploadFile', function (e) {
    e.preventDefault();                                                                                 
    var xhr = new XMLHttpRequest();                                            // create new xhr object
    var itemsArray = new Array();                                              // array to store selected peaks, waypoints, locations and participants

    // Execute following code when JSON object is received from importGpsTmp.php - TEMP service
    xhr.onload = function() {
        if (xhr.status === 200) {                                              // when all OK
            respObj = JSON.parse(xhr.responseText);                     // transfer JSON into response object array
            if ( respObj.status == 'OK') {

                // assign returned track values to UI fields
                trackobj = respObj.trackObj;
                //$('#uiAdmTrk_fld_trkId').val(trackobj.trkId); 
                $('#uiAdmTrk_fld_trkTrackName').val(trackobj.trkTrackName);    
                $('#uiAdmTrk_fld_trkRoute').val(trackobj.trkRoute);
                $('#uiAdmTrk_fld_trkDateBegin').val(trackobj.trkDateBegin);
                $('#uiAdmTrk_fld_trkDateFinish').val(trackobj.trkDateFinish);
                $('#uiAdmTrk_fld_trkSaison').val(trackobj.trkSaison);
                $('#uiAdmTrk_fld_trkType').val(trackobj.trkType);
                $('#uiAdmTrk_fld_trkSubType').val(trackobj.trkSubType);
                $('#uiAdmTrk_fld_trkOrg').val(trackobj.trkOrg);
                $('#uiAdmTrk_fld_trkOvernightLoc').val(trackobj.trkOvernightLoc);
                $('#uiAdmTrk_fld_trkParticipants').val(trackobj.trkParticipants);
                $('#uiAdmTrk_fld_trkEvent').val(trackobj.trkEvent);
                $('#uiAdmTrk_fld_trkRemarks').val(trackobj.trkRemarks);
                $('#uiAdmTrk_fld_trkDistance').val(trackobj.trkDistance);
                $('#uiAdmTrk_fld_trkTimeOverall').val(trackobj.trkTimeOverall);
                $('#uiAdmTrk_fld_trkTimeToPeak').val(trackobj.trkTimeToPeak);
                $('#uiAdmTrk_fld_trkTimeToFinish').val(trackobj.trkTimeToFinish);
                $('#uiAdmTrk_fld_trkGrade').val(trackobj.trkGrade);
                $('#uiAdmTrk_fld_trkMeterUp').val(trackobj.trkMeterUp);
                $('#uiAdmTrk_fld_trkMeterDown').val(trackobj.trkMeterDown);
                $('#uiAdmTrk_fld_trkCountry').val(trackobj.trkCountry);
                $('#uiAdmTrk_fld_trkCoordinates').val(trackobj.trkCoordinates);
                
                // not displayed fields
                $trkStartEle = trackobj.trkStartEle;                        
                $trkPeakEle = trackobj.trkPeakEle;                          
                $trkPeakTime = trackobj.trkPeakTime;                        
                $trkLowEle = trackobj.trkLowEle;                            
                $trkLowTime = trackobj.trkLowTime;                          
                $trkFinishEle = trackobj.trkFinishEle;
                $trkFinishTime = trackobj.trkFinishTime;
                $trkCoordTop = trackobj.trkCoordTop;
                $trkCoordBottom = trackobj.trkCoordBottom;
                $trkCoordLeft = trackobj.trkCoordLeft;
                $trkCoordRight = trackobj.trkCoordRight;
                //coordCenterX = trackobj.coordCenterX;
                //coordCenterY = trackobj.coordCenterY;
                
                // Close upload file div and open form to update track data
                $('#uiUplFileGps').removeClass('active');
                $('#uiAdmTrk').addClass('active');
                //document.getElementById("inputFile").value = "";

            } else {
                $('#statusMessage').text(respObj.message);
                $("#statusMessage").show().delay(5000).fadeOut();
                document.getElementById("inputFile").value = "";
            } 

        }
    }
    var fileName = document.getElementById('inputFile').files[0];               // assign selected file var
    if ( fileName ) {
        phpLocation = "services/importGps.php";                                 // Variable to store location of php file
        var formData = new FormData();                                          // create new formData object
        formData.append('sessionid', sessionid);                                // append parameter session ID
        formData.append('request', 'temp')                                      // temp request to create track temporarily
        formData.append('filename', fileName);                                  // append parameter filename
        formData.append('loginname', $loginName);                               // append parameter file type
        xhr.open ('POST', phpLocation, true);                                   // open  XMLHttpRequest 
        xhr.send(formData);                                                     // send formData object to service using xhr
    } else {
        $('#statusMessage').text('No file selected');
        $("#statusMessage").show().delay(5000).fadeOut();
    }
});

// Fires when users clicks the load JSON file button --> JSON file is imported into DB (not public function)
$(document).on('click', '#buttonUploadFileJSON', function (e) {
    e.preventDefault();
    var xhr = new XMLHttpRequest();   
    var jsonObject = {};
        
    // Execute following code JSON object is received from importGpsTmp.php - TEMP service
    xhr.onload = function() {
        if (xhr.status === 200) {                                                                       // when all OK
            respObj = JSON.parse(xhr.responseText);                                              // transfer JSON into response object array
            if ( respObj.status == 'OK') {
            } else {
                $('#statusMessage').text(respObj.message);
                $("#statusMessage").show().delay(5000).fadeOut();
            }
        }
    } 
    var fileName = $('#inputFileJSON').val();
    phpLocation = "services/importGps.php";          // Variable to store location of php file
    jsonObject["sessionid"] = sessionid;                             // append parameter session ID
    jsonObject["request"] = 'json';                              // temp request to create track temporarily
    jsonObject["filename"] = fileName;                              // send track object
    jsonObject["loginname"] = $loginName;
    xhr.open ('POST', phpLocation, true);                           // open  XMLHttpRequest 
    xhr.setRequestHeader( "Content-Type", "application/json" );
    jsn = JSON.stringify(jsonObject);
    xhr.send( jsn );                                           // send formData object to service using xhr  
});

// Fires when delete symbol on items table is clicked
$(document).on('click', '.itemDel', function (e) {
    console.info("clicked on del")
    e.preventDefault();                                                         // Prevent link behaviour
    var $activeButtonA = $(this)                                                // Store the current link <a> element
    var itemDelId = this.hash;                                                  // Get div class of selected topic (e.g #panelDisplay)
    var itemType = itemDelId.substring(1,5);                                    // Get type of item to delete
    var itemId = itemDelId.substring(9);                                        // Extract id of item to be deleted

    // Loop through items array and set display flag to false --> these records will not be saved/shown
    for (var i = 0; i < itemsArray.length; i++) {
        if ( itemsArray[i]["itemId"] == itemId && itemsArray[i]["itemType"] == itemType ) {
            itemsArray[i]["disp_f"] = false;
        }    
    }
    drawItemsTables ( itemsArray, itemType );                                   // call function to draw items table
});

// Fires when reached checkbox is changed
$(document).on('click', '.cbReached', function (e) {
    console.info("checkbox ticked")
    e.preventDefault();                                                         // Prevent link behaviour
    var $activeCb = $(this)                                                     // Store the current link <a> element
    var itemChecked = $activeCb.is(":checked");                                 // Store state of checkbox
    cbId = $activeCb.attr("id");                                                // Read id of checked checkbox
    var itemType = cbId.substring(3,7);                                         // Extract item type
    var itemId = cbId.substring(7);                                             // Extract item id

    // Loop through items array and set reached flag to false --> these records will not be saved/shown
    for (var i = 0; i < itemsArray.length; i++) {
        if ( itemsArray[i]["itemId"] == itemId && itemsArray[i]["itemType"] == itemType ) {
            itemsArray[i]["reached_f"] = itemChecked;
        }    
    }
    drawItemsTables ( itemsArray, "peak" ); 
});

// Upon click on the 'Save' button --> call importGps.php in save mode (call php with JQUERY $AJAX)
$(document).on('click', '#uiAdmTrk_fld_save', function (e) {
    e.preventDefault();
    var valid = true;                                                           // true when field check are passed
    var trackobj = {};
    var jsonObject = {};

    //$('#uiAdmTrk_fld_trkId').removeClass( "ui-state-error" );                   // remove error state if previously set
    //valid = valid && checkExistance ( $('#uiAdmTrk_fld_trkId'), "Track ID" );   // check validity of field
    //trackobj.trkId = $('#uiAdmTrk_fld_trkId').val();                            // assign field value to track object

    $('#uiAdmTrk_fld_trkTrackName').removeClass( "ui-state-error" );            // same as above
    valid = valid && checkExistance ( $('#uiAdmTrk_fld_trkTrackName'), "Track Name" );
    valid = valid && checkRegexpNot ( $('#uiAdmTrk_fld_trkTrackName'), /[&;,"']/, "No special characters [&;,\"\'] allowed. " );
    trackobj.trkTrackName = $('#uiAdmTrk_fld_trkTrackName').val();
    
    $('#uiAdmTrk_fld_trkRoute').removeClass( "ui-state-error" );                // same as above
    valid = valid && checkExistance ( $('#uiAdmTrk_fld_trkRoute'), "Route" );
    valid = valid && checkRegexpNot ( $('#uiAdmTrk_fld_trkRoute'), /[&;,"']/, "No special characters [&;,\"\'] allowed. " );
    trackobj.trkRoute = $('#uiAdmTrk_fld_trkRoute').val();
    
    $('#uiAdmTrk_fld_trkDateBegin').removeClass( "ui-state-error" );            // same as above
    valid = valid && checkExistance ( $('#uiAdmTrk_fld_trkDateBegin'), "Date Begin" );
    trackobj.trkDateBegin = $('#uiAdmTrk_fld_trkDateBegin').val();     

    $('#uiAdmTrk_fld_trkDateFinish').removeClass( "ui-state-error" );           // same as above
    valid = valid && checkExistance ( $('#uiAdmTrk_fld_trkDateFinish'), "Date Finish" );
    trackobj.trkDateFinish = $('#uiAdmTrk_fld_trkDateFinish').val();
    
    trackobj.trkSaison = $('#uiAdmTrk_fld_trkSaison').val();
    trackobj.trkType = $('#uiAdmTrk_fld_trkType').val();
    trackobj.trkSubType = $('#uiAdmTrk_fld_trkSubType').val();

    $('#uiAdmTrk_fld_trkOrg').removeClass( "ui-state-error" );           // same as above
    trackobj.trkOrg = $('#uiAdmTrk_fld_trkOrg').val();    
    valid = valid && checkRegexpNot ( $('#uiAdmTrk_fld_trkOrg'), /[&;,"']/, "No special characters [&;,\"\'] allowed. " );
    
    //trackobj.trkOvernightLoc = $('#uiAdmTrk_fld_trkOvernightLoc').val();
    //trackobj.trkParticipants = $('#uiAdmTrk_fld_trkParticipants').val();
    
    $('#uiAdmTrk_fld_trkEvent').removeClass( "ui-state-error" );           // same as above
    trackobj.trkEvent = $('#uiAdmTrk_fld_trkEvent').val();
    valid = valid && checkRegexpNot ( $('#uiAdmTrk_fld_trkEvent'), /[&;,"']/, "No special characters [&;,\"\'] allowed " );

    $('#uiAdmTrk_fld_trkRemarks').removeClass( "ui-state-error" );           // same as above
    trackobj.trkRemarks = $('#uiAdmTrk_fld_trkRemarks').val();
    valid = valid && checkRegexpNot ( $('#uiAdmTrk_fld_trkRemarks'), /[&;,"']/, "No special characters [&;,\"\'] allowed " );

    $('#uiAdmTrk_fld_trkDistance').removeClass( "ui-state-error" );           // same as above
    trackobj.trkDistance = $('#uiAdmTrk_fld_trkDistance').val();
    valid = valid && checkRegexp ( $('#uiAdmTrk_fld_trkDistance'), /^[0-9]{0,3}.[0-9]{0,3}$/, "Enter distance as mmm.nnn " );


    $('#uiAdmTrk_fld_trkTimeOverall').removeClass( "ui-state-error" );                   // remove error state if previously set
    trackobj.trkTimeOverall = $('#uiAdmTrk_fld_trkTimeOverall').val();
    valid = valid && checkRegexp ( $('#uiAdmTrk_fld_trkTimeOverall'), /^[0-9]{0,1}[0-9]:[0-9]{0,1}[0-9]:[0-9]{0,1}[0-9]$/, "Enter time as HH:MM:SS " );
    
    $('#uiAdmTrk_fld_trkTimeToPeak').removeClass( "ui-state-error" );                   // remove error state if previously set
    trackobj.trkTimeToPeak = $('#uiAdmTrk_fld_trkTimeToPeak').val();
    valid = valid && checkRegexp ( $('#uiAdmTrk_fld_trkTimeToPeak'), /^[0-9]{0,1}[0-9]:[0-9]{0,1}[0-9]:[0-9]{0,1}[0-9]$/, "Enter time as HH:MM:SS " );

    $('#uiAdmTrk_fld_trkTimeToFinish').removeClass( "ui-state-error" );                   // remove error state if previously set
    trackobj.trkTimeToFinish = $('#uiAdmTrk_fld_trkTimeToFinish').val();
    valid = valid && checkRegexp ( $('#uiAdmTrk_fld_trkTimeToFinish'), /^[0-9]{0,1}[0-9]:[0-9]{0,1}[0-9]:[0-9]{0,1}[0-9]$/, "Enter time as HH:MM:SS " );

    trackobj.trkGrade = $('#uiAdmTrk_fld_trkGrade').val();

    $('#uiAdmTrk_fld_trkMeterUp').removeClass( "ui-state-error" );                   // remove error state if previously set
    trackobj.trkMeterUp = $('#uiAdmTrk_fld_trkMeterUp').val();
    valid = valid && checkIfNum ( $('#uiAdmTrk_fld_trkMeterUp'), "Enter valid number (mmmm.nnn)");
    valid = valid && checkRegexp ( $('#uiAdmTrk_fld_trkMeterUp'), /^[0-9]{0,4}\.?[0-9]{0,3}$/, "Enter valid negative number (mmmm.nnn)" );

    $('#uiAdmTrk_fld_trkMeterDown').removeClass( "ui-state-error" );                   // remove error state if previously set
    trackobj.trkMeterDown = $('#uiAdmTrk_fld_trkMeterDown').val();
    valid = valid && checkIfNum ( $('#uiAdmTrk_fld_trkMeterDown'), "Enter valid negative number (-mmmm.nnn)");
    valid = valid && checkRegexp ( $('#uiAdmTrk_fld_trkMeterDown'), /^-[0-9]{0,4}\.?[0-9]{0,3}$/, "Enter valid negative number (-mmmm.nnn)" );
    
    $('#uiAdmTrk_fld_trkCountry').removeClass( "ui-state-error" );                   // remove error state if previously set
    country = $('#uiAdmTrk_fld_trkCountry').val();
    trackobj.trkCountry = country.toUpperCase();
    valid = valid && checkRegexp ( $('#uiAdmTrk_fld_trkCountry'), /^[A-Za-z]{2}$/, "Enter valid country code" );   
     
    trackobj.trkCoordinates = $('#uiAdmTrk_fld_trkCoordinates').val();  
    trackobj.trkLoginName = $loginName;    

    // not displayed fields
    trackobj.trkStartEle = $trkStartEle;                        
    trackobj.trkPeakEle = $trkPeakEle;                          
    trackobj.trkPeakTime = $trkPeakTime;                        
    trackobj.trkLowEle = $trkLowEle;                            
    trackobj.trkLowTime = $trkLowTime;                          
    trackobj.trkFinishEle = $trkFinishEle;                      
    trackobj.trkFinishTime = $trkFinishTime;  
    trackobj.trkCoordTop = $trkCoordTop;
    trackobj.trkCoordBottom = $trkCoordBottom;
    trackobj.trkCoordLeft = $trkCoordLeft;
    trackobj.trkCoordRight = $trkCoordRight;
    //trackobj.coordCenterX = coordCenterX;
    //trackobj.coordCenterY = coordCenterY;                 

    if ( valid ) { 
        phpLocation = "services/importGps.php";                                 // Variable to store location of php file
        jsonObject.sessionid = sessionid;                                       // append parameter session ID
        jsonObject.request = 'save';                                            // temp request to create track temporarily
        jsonObject.loginname = $loginName;                                      // set login name
        jsonObject.itemsArray = itemsArray;                                     // Array containing selected peaks
        jsonObject.trackobj = trackobj;                                         // send track object
        jsn = JSON.stringify ( jsonObject );

        // Perform ajax call to php to save trackObject in table Tracks and other tables
        // (JQUERY was necessary because I did not success to send two dimensional array otherwise)
        $.ajax({
            url: phpLocation,
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: jsn
        })
        .done(function ( respObj ) {

            // Track object successfully stored in DB
            if ( respObj.status == 'OK') {

                // ------------------------------
                // Gen KML for imported File
                var xhr = new XMLHttpRequest();

                // gen_kml.php has generated kml file and returns to js
                // Draw map with imported track in center
                xhr.onload = function() {
                    if (xhr.status === 200) {  
                        respObj = JSON.parse(xhr.responseText);                      // transfer JSON into response object array
                        
                        if ( respObj["status"] == "OK") {

                            var latOut = 0;                                                 // counter for coord boundary resets
                            var lonOut = 0;
                            // delete existing map object and set empty div
                            var element = document.getElementById('displayMap-ResMap');
                            var parent = element.parentNode
                            parent.removeChild(element);
                            parent.innerHTML = '<div id="displayMap-ResMap"></div>';
                            
                            // Derive center of map to be projected
                            var coordTop = respObj.coordTop * 1;
                            if ( coordTop > 300000 || coordTop < 70000 || coordTop == 0 ) {
                                coordTop = 297000;                                          // Limit coord boundaries to Switzerland
                                latOut++;
                            }
                            var coordBottom = respObj.coordBottom * 1;
                            if ( coordBottom < 70000 || coordBottom > 300000 || coordBottom == 0 ) {
                                coordBottom = 74000;                                        // Limit coord boundaries to Switzerland
                                latOut++;
                            }
                            var coordLeft = respObj.coordLeft * 1;
                            if ( coordLeft < 105000 || coordLeft > 845000 || coordLeft == 0 ) {
                                coordLeft = 110000;                                         // Limit coord boundaries to Switzerland
                                lonOut++;
                            }
                            var coordRight = respObj.coordRight * 1;
                            if ( coordRight > 845000 || coordRight < 105000 || coordRight == 0 ) {
                                coordRight = 840000;                                        // Limit coord boundaries to Switzerland
                                lonOut++;
                            }

                            // Evluate coord center (if route is outside CH - show empty CH map)
                            var coordCenterY = ( coordTop + coordBottom ) / 2;
                            if ( latOut == 2 || lonOut == 2 ) {
                                coordCenterY = 190000;                       // latOut = 2 means that both lat points are outside CH
                                coordTop = 297000;
                                coordBottom = 74000;
                            }

                            var coordCenterX = ( coordRight + coordLeft ) / 2;
                            if ( latOut == 2 || lonOut == 2 ) {
                                coordCenterX = 660000;                       // lonOut = 2 means that both lon points are outside CH
                                coordRight = 840000;
                                coordLeft = 110000;
                            }

                            // Calculate required resolution
                            resolution1 = ( coordTop - coordBottom ) / 200;
                            resolution2 = ( coordRight - coordLeft ) / 200;
                            if ( resolution1 > resolution2 ) {
                                resolution = resolution1;
                            } else {
                                resolution = resolution2;
                            }
            
                            console.info("resolution: " + resolution + " - CoordCenterX: " + coordCenterX + " - CoordCenterY: " + coordCenterY);
                            // Draw empty map & center to provided coordinate
                            var tourdbMap = new ga.Map({
                                target: 'displayMap-ResMap',
                                view: new ol.View({resolution: resolution, center: [coordCenterX, coordCenterY]})
                            });
                            mapSTlayer_grau = ga.layer.create('ch.swisstopo.pixelkarte-grau');
                            tourdbMap.addLayer(mapSTlayer_grau);                              // add map layer to map
                            
                            // Draw kml file for tracks 
                            if ( genTrackKml ) {                                            // var is true when user has set filter on tracks
                                $trackFile = document.URL + "tmp/kml_disp/" + sessionid + "/tracks.kml";
                            
                                // Create the KML Layer for tracks
                                kmlLayer = new ol.layer.Vector({                       // create new vector layer for tracks
                                    source: new ol.source.Vector({                          // Set source to kml file
                                        url: $trackFile,
                                        format: new ol.format.KML({
                                            projection: 'EPSG:21781'
                                        })
                                    })
                                });
                                tourdbMap.addLayer(kmlLayer);                                // add track layer to map
                            }
                            
                            // Popup showing the position the user clicked
                            var popup = new ol.Overlay({                                    // popup to display track details
                                element: $('<div title="KML"></div>')[0]
                            });
                            tourdbMap.addOverlay(popup);
            
                            // On click we display the feature informations (code basis from map admin sample library)
                            tourdbMap.on('singleclick', function(evt) {
                                var pixel = evt.pixel;
                                var coordinate = evt.coordinate;
                                var feature = tourdbMap.forEachFeatureAtPixel(pixel, function(feature, layer) {
                                    return feature;
                                });
                                var element = $(popup.getElement());
                                element.popover('destroy');
                                if (feature) {
                                popup.setPosition(coordinate);
                                element.popover({
                                    'placement': 'top',
                                    'animation': false,
                                    'html': true,
                                    'content': feature.get('name')
                                });
                                element.popover('show');
                                }
                            });
            
                            // Change cursor style when cursor is hover over a feature
                            tourdbMap.on('pointermove', function(evt) {
                                var feature = tourdbMap.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                                    return feature;
                                });
                                tourdbMap.getTargetElement().style.cursor = feature ? 'pointer' : '';
                            });
            
                            // display message
                            if ( latOut > 0 ) {
                                $('#statusMessage').text("Not all objects could be (fully) displayey");    
                            } else {
                                $('#statusMessage').text(respObj.message);
                            }
                            $("#statusMessage").show().delay(5000).fadeOut();
                        }
                    }
                };     

                // Create where statement (to be changed --> trkId to be returned after save)
                sqlWhereCurrent = "WHERE trkId=" + respObj["trkId"];
                genTrackKml = true;
                sqlWhereCurrent = "";
                genSegKml = false;
                
                // send required parameters to gen_kml.php
                var jsonObject = {};
                phpLocation = "services/gen_kml.php";                                   // Variable to store location of php file
                jsonObject["sessionid"] = sessionid;                                    // send session ID
                jsonObject["sqlWhereCurrent"] = sqlWhereCurrent;                          // send where statement for tracks
                jsonObject["genTrackKml"] = genTrackKml;                                // send where statement for segments 
                jsonObject["sqlWhereCurrent"] = sqlWhereCurrent;                             
                jsonObject["genSegKml"] = genSegKml;                                    // append parameter session ID
                xhr.open ('POST', phpLocation, true);                                   // open  XMLHttpRequest 
                xhr.setRequestHeader( "Content-Type", "application/json" );
                jsn = JSON.stringify(jsonObject);
                xhr.send( jsn );                                                        // send formData object to service using xhr   
                // ------------------------------

                $('#statusMessage').text(respObj.message);
                $('#statusMessage').show().delay(5000).fadeOut();
      
                // empty items array and redraw empty items array
                itemsArray = new Array();
                drawItemsTables ( itemsArray, "peak" ); 
                drawItemsTables ( itemsArray, "wayp" ); 
                drawItemsTables ( itemsArray, "loca" ); 
                drawItemsTables ( itemsArray, "part" ); 

                $( "#uiAdmTrk_peakSrch" ).val("");
                $( "#uiAdmTrk_waypSrch" ).val("");
                $( "#uiAdmTrk_locaSrch" ).val("");
                $( "#uiAdmTrk_partSrch" ).val("");

                // Open Panel Display
                var $activeButtonA = $('#navBtns_btn_diplay_a');                // Store the current link <a> element
                buttonId = $activeButtonA.attr('href'); 

                // Run following block if selected topic is currently not active
                $topicButton.removeClass('active');                             // Make current panel inactive
                $activeButton.removeClass('active');                            // Make current tab inactive
                $topicButton = $(buttonId).addClass('active');                  // Make new panel active
                $activeButton = $activeButtonA.parent().addClass('active');     // Make new tab active
                
                // Close upload file div and open form to update track data
                $('#uiUplFileGps').addClass('active');
                $('#uiAdmTrk').removeClass('active');

                // Change active tab to main tab
                $( "#uiAdmTrk" ).tabs({
                    active: 0
                  });
            } else {
                // Track and / related tables could not be correctly inserted
                // Task?: Make panelImport disappear and panelDisplay appear
                $('#statusMessage').text(respObj.message);
                $('#statusMessage').show().delay(5000).fadeOut();
            }
        });
    }
});

// On click on the 'cancel' button --> cancel update & delete temp track (call php with xhr in JSON mode)
$(document).on('click', '#uiAdmTrk_fld_cancel', function (e) {
    e.preventDefault();
    $('#uiUplFileGps').addClass('active');                 // Make File upload div visible
    $('#uiAdmTrk').removeClass('active');                   // hide update form
    $('#statusMessage').text('Import cancelled');
    $("#statusMessage").show().delay(5000).fadeOut();
});

// ==========================================================================
// ========================== panelExport ===================================
// ==========================================================================

// Export Tracks JSON Button clicked
$(document).on('click', '#buttonExportTracks01JSON', function (e) {
    e.preventDefault();
    var xhr = new XMLHttpRequest();   
    var jsonObject = {};
        
    // Execute following code JSON object is received from importGpsTmp.php - TEMP service
    xhr.onload = function() {
        if (xhr.status === 200) {                                               // when all OK
            respObj = JSON.parse(xhr.responseText);                      // transfer JSON into response object array
            $('#statusMessage').text(respObj.message);
            $("#statusMessage").show().delay(5000).fadeOut();
        } 
    } 

    phpLocation = "services/exportData.php";                                    // Variable to store location of php file
    jsonObject["request"] = 'tracks01_JSON';                                    // temp request to create track temporarily
    jsonObject["loginname"] = $loginName;
    xhr.open ('POST', phpLocation, true);                                       // open  XMLHttpRequest 
    xhr.setRequestHeader( "Content-Type", "application/json" );
    jsn = JSON.stringify(jsonObject);
    xhr.send( jsn );                                                            // send formData object to service using xhr  
});

// Export Tracks CSV Button clicked
$(document).on('click', '#buttonExportTracks01CSV', function (e) {
    e.preventDefault();
    var xhr = new XMLHttpRequest();   
    var jsonObject = {};
        
    // Execute following code JSON object is received from importGpsTmp.php - TEMP service
    xhr.onload = function() {
        if (xhr.status === 200) {                                               // when all OK
            respObj = JSON.parse(xhr.responseText);                      // transfer JSON into response object array
            $('#statusMessage').text(respObj.message);
            $("#statusMessage").show().delay(5000).fadeOut();
        }
    } 

    phpLocation = "services/exportData.php";                                    // Variable to store location of php file
    jsonObject["request"] = 'tracks01_CSV';                                     // temp request to create track temporarily
    jsonObject["loginname"] = $loginName;
    xhr.open ('POST', phpLocation, true);                                       // open  XMLHttpRequest 
    xhr.setRequestHeader( "Content-Type", "application/json" );
    jsn = JSON.stringify(jsonObject);
    xhr.send( jsn );                                                            // send formData object to service using xhr  
});

// =============================================
// ============ F U N C T I O N S ==============
// =============================================

// Function drawing empty map -- for documentation see: https://api3.geo.admin.ch/
function drawMapEmpty(targetDiv) {
    
    var tourdbMap = new ga.Map({
        target: targetDiv,
        view: new ol.View({resolution: 500, center: [660000, 190000]})
    });

    // Create a background layer
    mapSTlayer_grau = ga.layer.create('ch.swisstopo.pixelkarte-grau');
    tourdbMap.addLayer(mapSTlayer_grau);
    return tourdbMap;
}

function drawMap( targetDiv, resolution, coordCenterX, coordCenterY, kmlFiles ) {

    // parameters:
    // targetDiv: ID of target div
    // resolution: map resolution 
    // coordCenterX / Y: location of map center
    // kmlFiles: Array of KML files which need to be displayed

    // Delete previously drawn map

    // Delete previously drawn layers 
    tourdbMap.getLayers().forEach(function(el) {                      // Loop through all map layers and remove them
        tourdbMap.removeLayer(el);
    })
    mapSTlayer_grau = ga.layer.create('ch.swisstopo.pixelkarte-grau');
    tourdbMap.addLayer(mapSTlayer_grau);                              // add map layer to map
    
    // Draw empty map & center to provided coordinate
    var tourdbMap = new ga.Map({
        target: targetDiv,
        view: new ol.View({resolution: resolution, center: [coordCenterY, coordCenterX]})
    });

    // Create a background layer
    mapSTlayer_grau = ga.layer.create('ch.swisstopo.pixelkarte-grau');
    tourdbMap.addLayer(mapSTlayer_grau);
    
    // Draw kml file for each file delivered in kmlFiles array
    for (var i = 0; i < kmlFiles.length; i++) {

        kmlFile = kmlFiles[i];

        // Create the KML Layer for tracks
        layer = new ol.layer.Vector({                       // create new vector layer for tracks
            source: new ol.source.Vector({                          // Set source to kml file
                url: kmlFile,
                format: new ol.format.KML({
                    projection: 'EPSG:21781'
                })
            })
        });
        tourdbMap.addLayer(layer);                                // add track layer to map    
    } 
    /*
    // Popup showing the position the user clicked
    var popup = new ol.Overlay({                                    // popup to display track details
        element: $('<div title="KML"></div>')[0]
    });
    tourdbMap.addOverlay(popup);

    // On click we display the feature informations (code basis from map admin sample library)
    tourdbMap.on('singleclick', function(evt) {
        var pixel = evt.pixel;
        var coordinate = evt.coordinate;
        var feature = tourdbMap.forEachFeatureAtPixel(pixel, function(feature, layer) {
            return feature;
        });
        var element = $(popup.getElement());
        element.popover('destroy');
        if (feature) {
        popup.setPosition(coordinate);
        element.popover({
            'placement': 'top',
            'animation': false,
            'html': true,
            'content': feature.get('name')
        });
        element.popover('show');
        }
    });

    // Change cursor style when cursor is hover over a feature
    tourdbMap.on('pointermove', function(evt) {
        var feature = tourdbMap.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
            return feature;
        });
        tourdbMap.getTargetElement().style.cursor = feature ? 'pointer' : '';
    });
    */
}

// ==================================================
// == Functions to validate fields at insert & update

// Function updating Validation Comments    
function updateValComments( text ) {
    valComments
        .text( text )
        .addClass( "ui-state-highlight" );
    //setTimeout(function() {
    //    valComments.removeClass( "ui-state-highlight", 1500 );
    //}, 500 );
}

// Funtion checking existance of file content in ADD dialog
function checkExistance( origin, name ) {
    if ( origin.val().length == 0 ) {
        origin.addClass( "ui-state-error" );
        updateValComments( "Field " + name + " must be entered" );
        return false;
    } else {
        return true;
    }
}

// Draws the table that list the selected waypoints
function drawItemsTables ( itemsArray, itemType ) {

    // Assign var
    var itemClass = "tblItems";
    var itemDelClass = itemType + "Del";                                        // e.g. waypDel
    var itemDelImg = "btn" + itemType + "DelImg";                               // e.g. btnwaypDelImg
    var elementId = "uiAdmTrk_" + itemType + "List";                            // e.g. uiAdmTrk_peakList
    var reachedCheck = "cb_" + itemType;                                        // e.g. cb_peak

    // create new html table with value returned by autocomplete
    var itemsTable = '';
    itemsTable += '<table class="itemsTable" cellspacing="0" cellpadding="0">';
    if ( itemType == "peak" ) {
        itemsTable += '<tr><td>Peak</td><td>   reached</td><td></td></tr>';
    } else if ( itemType == "wayp" ) {
        itemsTable += '<tr><td>Waypoint</td><td></td></tr>';
    } else if ( itemType == "loca" ) {
        itemsTable += '<tr><td>Location</td><td></td></tr>';
    } else if ( itemType == "part" ) {
        itemsTable += '<tr><td>Participant</td><td></td></tr>';
    }
    // loop through items array and draw table content
    for (var i = 0; i < itemsArray.length; i++) {
        if ( itemsArray[i]["disp_f"] == true && itemsArray[i]["itemType"] == itemType ) {
            itemsTable += '<tr class="' + itemClass + '">';  
            itemsTable += '<td>' + itemsArray[i]["itemName"] + '</td>';               // 1    
            // if item = peak the reached flag needs to be displayed
            if ( itemType == "peak" ) {
                itemsTable += '<td><input type="checkbox" name="' + reachedCheck + itemsArray[i]["itemId"]
                    + '" id="' + reachedCheck + itemsArray[i]["itemId"];
                if ( itemsArray[i]["reached_f"] ) {
                    itemsTable += '" class="cbReached" checked></td>'; 
                } else {
                    itemsTable += '" class="cbReached"></td>'; 
                }
            }
            itemsTable += '<td><ul class="' + itemClass + '">';
            itemsTable += '<li class="button_Li"><a class="itemDel button_A"' 
                            + ' href="#' + itemDelClass + '_' + itemsArray[i]["itemId"] + '">'
                            + '<img id="' + itemDelImg + '" src="css/images/delete.png"></a></li></ul></td>';
                            itemsTable += '</tr>';
        }               
    }
    itemsTable += '</table>';   
    document.getElementById(elementId).innerHTML = itemsTable;
}

// function checking of field against REGEX - error when matching
function checkRegexpNot( o, regexp, n ) {
    if ( regexp.test( o.val() ) )  {
        o.addClass( "ui-state-error" );
        updateValComments( n );
        return false;
    } else {
        return true;
    }
}

// function checking of field against REGEX - error when NOT matching
function checkRegexp( o, regexp, n ) {
    if ( !( regexp.test( o.val() ) ) ) {
        o.addClass( "ui-state-error" );
        updateValComments( n );
        return false;
    } else {
        return true;
    }
}

// function checking if content of field is a number
function checkIfNum( o, n ) {
    if ( isNaN( o.val() ) ) {                                                   // isNaN returns false if value is a number --> 1234 = false
        o.addClass( "ui-state-error" );
        updateValComments( n );
        return false;
    } else {
        return true;
    }
}

// Function checking the min / max length of field content of ADD dialog 
function checkLength( o, n, min, max ) {
    if ( o.val().length > max || o.val().length < min ) {
        o.addClass( "ui-state-error" );
        updateValComments( "Length of " + n + " must be between " + min + " and " + max + "." );
        return false;
    } else {
        return true;
    }
}

function DisplayObj ( objectName, sqlWherePrev, sqlWhereCurrent, genKml, jsonObject, ajaxCall ) {
    this.objectName = objectName;
    this.sqlWherePrev = sqlWherePrev;
    this.sqlWhereCurrent = sqlWhereCurrent;
    this.genKml = genKml; 
    this.jsonObject = jsonObject;
    this.ajaxCall = ajaxCall;
}